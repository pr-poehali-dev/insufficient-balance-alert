// ะกะบะพะฟะธััะนัะต ััะพั ะบะพะด ะฒ ัะฐะนะป server/index.ts ะฝะฐ ะฒะฐัะตะผ ะบะพะผะฟัััะตัะต

import express from 'express';
import cors from 'cors';
import Database from 'better-sqlite3';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const app = express();
const PORT = 3001;

app.use(cors());
app.use(express.json());

const db = new Database(join(__dirname, 'database.db'));

db.exec(`
  CREATE TABLE IF NOT EXISTS clients (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    phone TEXT NOT NULL,
    email TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );

  CREATE TABLE IF NOT EXISTS masters (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    phone TEXT,
    location TEXT,
    is_active BOOLEAN DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );

  CREATE TABLE IF NOT EXISTS orders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    client_name TEXT NOT NULL,
    client_phone TEXT NOT NULL,
    client_email TEXT,
    location TEXT NOT NULL,
    car_type TEXT NOT NULL,
    service TEXT NOT NULL,
    service_duration INTEGER NOT NULL,
    service_price REAL NOT NULL,
    booking_date TEXT NOT NULL,
    booking_time TEXT NOT NULL,
    status TEXT DEFAULT 'pending',
    notes TEXT,
    assigned_master_id INTEGER,
    assigned_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (assigned_master_id) REFERENCES masters(id)
  );
`);

const masterCheck = db.prepare('SELECT COUNT(*) as count FROM masters').get() as { count: number };
if (masterCheck.count === 0) {
  const insertMaster = db.prepare('INSERT INTO masters (name, phone, location) VALUES (?, ?, ?)');
  insertMaster.run('ะะฒะฐะฝ ะะตััะพะฒ', '+7 (999) 111-11-11', 'ัะป. ะะตะฝะธะฝะฐ, 45');
  insertMaster.run('ะกะตัะณะตะน ะะฒะฐะฝะพะฒ', '+7 (999) 222-22-22', 'ะฟั. ะะธัะฐ, 123');
  insertMaster.run('ะะปะตะบัะตะน ะกะผะธัะฝะพะฒ', '+7 (999) 333-33-33', 'ัะป. ะะฐะณะฐัะธะฝะฐ, 78');
  console.log('โ ะะพะฑะฐะฒะปะตะฝั ัะตััะพะฒัะต ะผะฐััะตัะฐ');
}

app.get('/api/bookings', (req, res) => {
  try {
    const { status } = req.query;
    let query = 'SELECT * FROM orders ORDER BY booking_date DESC, booking_time DESC';
    let orders;

    if (status) {
      query = 'SELECT * FROM orders WHERE status = ? ORDER BY booking_date DESC, booking_time DESC';
      orders = db.prepare(query).all(status);
    } else {
      orders = db.prepare(query).all();
    }

    res.json(orders);
  } catch (error) {
    console.error('Error fetching orders:', error);
    res.status(500).json({ error: 'Failed to fetch orders' });
  }
});

app.post('/api/bookings', (req, res) => {
  try {
    const {
      clientName,
      clientPhone,
      clientEmail,
      location,
      carType,
      service,
      serviceDuration,
      servicePrice,
      bookingDate,
      bookingTime,
    } = req.body;

    const stmt = db.prepare(`
      INSERT INTO orders (
        client_name, client_phone, client_email, location,
        car_type, service, service_duration, service_price,
        booking_date, booking_time, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending')
    `);

    const result = stmt.run(
      clientName,
      clientPhone,
      clientEmail || '',
      location,
      carType,
      service,
      serviceDuration,
      servicePrice,
      bookingDate,
      bookingTime
    );

    const order = db.prepare('SELECT * FROM orders WHERE id = ?').get(result.lastInsertRowid);
    res.status(201).json(order);
  } catch (error) {
    console.error('Error creating order:', error);
    res.status(500).json({ error: 'Failed to create order' });
  }
});

app.put('/api/bookings', (req, res) => {
  try {
    const { id, status, notes, assignedMasterId } = req.body;

    if (!id) {
      return res.status(400).json({ error: 'Order ID is required' });
    }

    const updates: string[] = ['updated_at = CURRENT_TIMESTAMP'];
    const params: any[] = [];

    if (status !== undefined) {
      updates.push('status = ?');
      params.push(status);
    }

    if (notes !== undefined) {
      updates.push('notes = ?');
      params.push(notes);
    }

    if (assignedMasterId !== undefined) {
      updates.push('assigned_master_id = ?');
      params.push(assignedMasterId || null);
      
      if (assignedMasterId) {
        updates.push('assigned_at = CURRENT_TIMESTAMP');
        updates.push('status = ?');
        params.push('in-progress');
      }
    }

    params.push(id);

    const query = `UPDATE orders SET ${updates.join(', ')} WHERE id = ?`;
    db.prepare(query).run(...params);

    const order = db.prepare('SELECT * FROM orders WHERE id = ?').get(id);
    
    if (order) {
      res.json(order);
    } else {
      res.status(404).json({ error: 'Order not found' });
    }
  } catch (error) {
    console.error('Error updating order:', error);
    res.status(500).json({ error: 'Failed to update order' });
  }
});

app.get('/api/masters', (req, res) => {
  try {
    const { masterId } = req.query;

    if (masterId) {
      const orders = db.prepare(`
        SELECT o.*, m.name as master_name
        FROM orders o
        LEFT JOIN masters m ON o.assigned_master_id = m.id
        WHERE o.assigned_master_id = ?
        ORDER BY o.booking_date DESC, o.booking_time DESC
      `).all(masterId);
      
      res.json(orders);
    } else {
      const masters = db.prepare('SELECT * FROM masters WHERE is_active = 1 ORDER BY name').all();
      res.json(masters);
    }
  } catch (error) {
    console.error('Error fetching masters:', error);
    res.status(500).json({ error: 'Failed to fetch masters' });
  }
});

app.listen(PORT, () => {
  console.log(`๐ ะะพะบะฐะปัะฝัะน ัะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ http://localhost:${PORT}`);
  console.log(`๐ ะะฐะทะฐ ะดะฐะฝะฝัั: ${join(__dirname, 'database.db')}`);
});
